# README

## Project Description

This project collects data from an industrial device (e.g., TC-900 from Full Gauge), formats it, and sends it to ThingsBoard Cloud using a resilient HTTP client. It is designed to be reliable, modular, and easy to maintain.

---

## Project Structure

```
scripts/
├── venv/ ← Python virtual environment
├── send_to_tb/ ← Main Python package
│ ├── init.py
│ ├── .env
│ ├── main.py
│ ├── clients/
│ │ ├── init.py
│ │ ├── http_client.py
│ │ └── thingsboard_client.py
│ ├── fetchers/
│ │ ├── init.py
│ │ ├── data_fetcher.py
│ │ └── sitrad_data_fetcher.py
│ ├── launcher/
│ │ ├── init.py
│ │ └── send_launcher.py
│ └── utils/
│ ├── init.py
│ ├── log_cleaner.py ← automatically purge old log files
│ └── db_cleaner.py ← delete sent rows from the database
├── sitrad/
│ └── setup_sitrad.sh ← Launch Wine + Sitrad PRO
├── setup_bash/
│ ├── setup_services.sh ← Install systemd services (Sitrad + send_to_tb)
│ └── kill_services.sh ← Uninstall the systemd services
```
---

## Prerequisites

- Python 3.7+
- `requests` library
- Linux or Raspberry Pi with `systemd --user`
- Access to ThingsBoard Cloud (device token)
- SQLite database generated by Sitrad

---

## Step-by-Step Installation

### 1. Create and Activate the Virtual Environment

```bash
cd /path/to/scripts
python3 -m venv venv
source venv/bin/activate
```

### 2. Install Python Dependencies

With the virtual environment activated:

```bash
pip install --upgrade pip
pip install requests
pip install python-dotenv
```

### 3. Prepare the .env File

In `scripts/send_to_tb/.env`:

```ini
###############################################################################
# ▶︎ Credentials
###############################################################################
# ThingsBoard device token
DEVICE_TOKEN=UuGa6uD0YW31ElEjxmEo

###############################################################################
# ▶︎ Paths
###############################################################################
# Chemin vers la base de données SQLite (via Wine)
DB_PATH=~/.wine/drive_c/ProgramData/Full Gauge/Sitrad/data.db
# Nom du fichier de logs (sera créé sous logs/)
LOG_FILE=sitrad_push.log

###############################################################################
# ▶︎ Behaviour
###############################################################################
# Limite douce : 10 messages par seconde
MAX_MSGS_PER_SEC=10
# Tentatives max (split & back-off compris)
MAX_RETRY=5
# Back-off initial (en millisecondes)
INITIAL_DELAY_MS=200
# DEBUG | INFO | WARNING | ERROR
LOG_LEVEL=DEBUG
# Timestamp minimal valide (2000-01-01 UTC en millisecondes)
MIN_VALID_TS_MS=946684800000
# Auto-delete logs older than X days
PURGE_LOG_DAYS=2
```

Notes:

- `DB_PATH` can use `~` or a full absolute path.
- `LOG_FILE` will be created under `send_to_tb/logs/` at runtime.

### 4. Make Scripts Executable

From the `scripts/` root:

```bash
chmod +x send_to_tb/main.py
chmod +x sitrad/setup_sitrad.sh
chmod +x setup_bash/setup_services.sh
chmod +x setup_bash/kill_services.sh
```

### 5. Manual Execution

Activate the virtual environment:

```bash
source venv/bin/activate
```

Option A:

```bash
cd send_to_tb
python main.py
```

Or, if `main.py` is executable:

```bash
./main.py

sqlite3 ~/.wine/drive_c/ProgramData/Full\ Gauge/Sitrad/data.db "SELECT COUNT(*) FROM tc900log;"
```

Option B:

```bash
cd scripts
python -m send_to_tb.main
```

---

## Automatic Execution On Boot

### Install Services

```bash
./setup_bash/setup_services.sh
```

This creates and enables:

- `~/.config/systemd/user/sitrad.service (auto restart on crash)`
- `~/.config/systemd/user/send_to_tb.timer (runs every 30 seconds)`

### Check Status

```bash
systemctl --user list-timers
journalctl --user -u sitrad.service -f
journalctl --user -u send_to_tb.service -n 50
```

### Uninstall Services

```bash
./setup_bash/kill_services.sh
```

---

## Launching Sitrad PRO (via Wine)

```bash
./sitrad/setup_sitrad.sh
```

---

## Internal Workings

### `main.py`

- Loads `.env` variables.
- Instantiates `SitradDataFetcher`.
- Instantiates `ThingsBoardClient`.
- Launches `SendToLauncher`.

### `SitradDataFetcher`

- `fetch_rows()`: Opens SQLite in WAL mode, selects all rows from `tc900log`.
- `build_payload(row)`: Validates timestamp, constructs payload with fields: `Temp1`, `Temp2`, `defr`, `fans`, `refr`, `dig1`, `dig2`.
- Includes `"rowid"`, `"ts"`, and a `"values"` dictionary.
- `fetch_and_prepare()`: Returns a list of payload dicts.

### `ThingsBoardClient`

- Builds the HTTP endpoint URL.
- `post_json_with_retry()`: Posts JSON with retry/back-off.
- `send_resilient(batch)`: Sends a batch of payloads reliably.

### `SendToLauncher`

- `start()`:
  - Calls `_fetch_payloads()` → list of payload dicts.
  - Calls `_send_in_chunks(payloads)` to split and send in mini-lots.
- `_fetch_payloads()`: Returns `[{"rowid":…, "ts":…, "values":{…}}, …]`.
- `_send_in_chunks(payloads)`:
  - Splits payloads into chunks of `MAX_MSGS_PER_SEC`.
  - Calls `_send_fine_grained_batch(chunk)` for each chunk.
  - Calls `_enforce_rate_limit(window_start)` to ensure ≤ N messages/sec.
- `_send_fine_grained_batch(batch)`:
  - Sends each payload individually (`send_resilient([payload])`).
  - Collects rowids of successful sends into a list.
  - Calls `delete_rows(db_path, rowids_to_delete)` once per batch.
- `_enforce_rate_limit(window_start)`: Sleeps the remaining time so that each chunk spans at least 1 second.

---

## Utils

- `utils/log_cleaner.py`: Deletes `.log` files older than `PURGE_LOG_DAYS`.
- `utils/db_cleaner.py`: Deletes sent rows from the SQLite `tc900log` table in one transaction.

---

## FAQ

**Q: How do I verify that rows were removed?**

```bash
sqlite3 ~/.wine/drive_c/ProgramData/Full\ Gauge/Sitrad/data.db "SELECT COUNT(*) FROM tc900log;"
```

**Q: How do I check if the script is running?**

```bash
systemctl --user list-timers
```

**Q: How do I view the send logs?**

```bash
journalctl --user -u send_to_tb.service -n 50
journalctl --user -u sitrad.service -f
```

**Q: Where should I run chmod +x?**

```bash
chmod +x send_to_tb/main.py
chmod +x setup_bash/setup_sitrad.sh
```

**Q: How can I test without actually sending data?**

Temporarily set:

```ini
MAX_MSGS_PER_SEC=0
```

Or comment out `send_resilient(...)` calls in the code.

**Q: How is ~ in DB_PATH handled?**

It’s expanded automatically via `os.path.expanduser()`.

**Q: Should I commit `venv/` to version control?**

No—add it to your `.gitignore`.

---

## Extension Possibilities

- Add a new `DataFetcher` (e.g., MySQL, API, CSV) by subclassing `DataFetcher`.
- Add a new `HttpClient` (e.g., Kafka, another IoT API) by subclassing `HttpClient`.
- The core `SendToLauncher` logic remains source/destination agnostic.

---

With this README you can:

- Initialize a Python virtual environment.
- Install dependencies.
- Make scripts executable.
- Run `send_to_tb` manually or via systemd timer.
- Monitor emissions to ThingsBoard.
- Adjust file paths as needed for your environment.
