# README

## Project Description

This project collects data from an industrial device (e.g., TC-900 from Full Gauge), formats it, and sends it to ThingsBoard Cloud using a resilient HTTP client. It is designed to be reliable, modular, and easy to maintain. It also supports running Sitrad PRO under Wine in a “headless” environment (no physical monitor), using a virtual X server.

---

## Project Structure

```
scripts/
├── venv/                       ← Python virtual environment
├── send_to_tb/                 ← Main Python package
│   ├── __init__.py
│   ├── .env
│   ├── main.py
│   ├── clients/
│   │   ├── __init__.py
│   │   ├── http_client.py
│   │   └── thingsboard_client.py
│   ├── fetchers/
│   │   ├── __init__.py
│   │   ├── data_fetcher.py
│   │   └── sitrad_data_fetcher.py
│   ├── launcher/
│   │   ├── __init__.py
│   │   └── send_launcher.py
│   └── utils/
│       ├── __init__.py
│       ├── log_cleaner.py        ← automatically purge old log files
│       └── db_cleaner.py         ← delete sent rows from the database
├── sitrad/
│   ├── setup_sitrad.sh           ← Launch Wine + Sitrad PRO (headless/Xvfb support)
│   └── send_ctrl_l_to_sitrad.sh  ← Auto‐send “Ctrl+L” to Sitrad window (headless)
├── setup_bash/
│   ├── setup_services.sh         ← Install systemd services (Sitrad + send_to_tb)
│   └── kill_services.sh          ← Uninstall the systemd services
```

---

## Prerequisites

- Python 3.7+  
- `requests` and `python-dotenv` (for the Python package)  
- Linux or Raspberry Pi with `systemd --user`  
- Access to ThingsBoard Cloud (device token)  
- SQLite database generated by Sitrad (under Wine)  
- Two additional packages for headless Sitrad:  
  1. **Xvfb** (X virtual framebuffer)  
  2. **xdotool** (to send “Ctrl+L” to the Sitrad window)  
  3. **openbox** (to send focus a virtual window)  

Install those with:

```bash
sudo apt update
sudo apt install -y openbox xdotool xvfb
```

---

## Step-by-Step Installation

### 1. Create and Activate the Virtual Environment

```bash
cd /path/to/scripts
python3 -m venv venv
source venv/bin/activate
```

### 2. Install Python Dependencies

With the virtual environment activated:

```bash
pip install --upgrade pip
pip install requests python-dotenv
```

### 3. Prepare the `.env` File

In `scripts/send_to_tb/.env`:

```ini
###############################################################################
# ▶︎ Credentials
###############################################################################
# ThingsBoard device token
DEVICE_TOKEN=UuGa6uD0YW31ElEjxmEo

###############################################################################
# ▶︎ Paths
###############################################################################
# Path to the SQLite database (via Wine)
DB_PATH=~/.wine/drive_c/ProgramData/Full Gauge/Sitrad/data.db
# Name of the log file (will be created under send_to_tb/logs/)
LOG_FILE=sitrad_push.log

###############################################################################
# ▶︎ Behaviour
###############################################################################
# Throttle: maximum messages per second
MAX_MSGS_PER_SEC=10
# Maximum retry attempts (with split & backoff)
MAX_RETRY=5
# Initial backoff in milliseconds
INITIAL_DELAY_MS=200
# Log level: DEBUG | INFO | WARNING | ERROR
LOG_LEVEL=DEBUG
# Minimum valid timestamp (e.g., Jan 1 2000 UTC in milliseconds)
MIN_VALID_TS_MS=946684800000
# Auto-delete logs older than X days
PURGE_LOG_DAYS=2
```

Notes:

- `DB_PATH` can use `~` or an absolute path.  
- `LOG_FILE` is created under `send_to_tb/logs/` at runtime.  

### 4. Make Scripts Executable

From the `scripts/` root:

```bash
chmod +x send_to_tb/main.py
chmod +x sitrad/setup_sitrad.sh
chmod +x sitrad/send_ctrl_l_to_sitrad.sh
chmod +x setup_bash/setup_services.sh
chmod +x setup_bash/kill_services.sh
```

### 5. Manual Execution

Activate the virtual environment:

```bash
source venv/bin/activate
```

#### Run Python data‐sender manually

Option A:

```bash
cd send_to_tb
python main.py
```

Or, if `main.py` is executable:

```bash
./main.py
```

You can check remaining rows with:

```bash
sqlite3 ~/.wine/drive_c/ProgramData/Full\ Gauge/Sitrad/data.db "SELECT COUNT(*) FROM tc900log;"
```

Option B (module style):

```bash
cd scripts
python -m send_to_tb.main
```

#### Run Sitrad PRO manually (headless)

```bash
./sitrad/setup_sitrad.sh
```

That will start Sitrad under Wine inside a virtual X server (Xvfb on `:1`), then after a short wait send “Ctrl+L” to begin communication.

---

## Automatic Execution On Boot

### Install Services

```bash
./setup_bash/setup_services.sh
```

This creates and enables:

- `~/.config/systemd/user/sitrad.service`  
  - Runs Sitrad under Wine in a headless Xvfb on `:1`  
  - Automatically restarts if it crashes  
- `~/.config/systemd/user/send_to_tb.timer`  
  - Triggers `send_to_tb.service` every 30 seconds (starts 10 s after boot)

### Check Status

```bash
systemctl --user list-timers
journalctl --user -u sitrad.service -f       # Follow Sitrad logs
journalctl --user -u send_to_tb.service -n 50  # Last 50 lines of telemetry‐sender logs
```

### Uninstall Services

```bash
./setup_bash/kill_services.sh
```

This stops & disables both Sitrad and the telemetry timer, and removes their unit files.

---

## Launching Sitrad PRO (via Wine, headless)

```bash
./sitrad/setup_sitrad.sh
```

- **Xvfb** will be started on `:1` (handled by `sitrad.service`).  
- Wine runs Sitrad in that virtual X server (`DISPLAY=:1`).  
- `setup_sitrad.sh` waits for the window, sleeps 30 s until Sitrad’s UI is fully loaded, then calls `send_ctrl_l_to_sitrad.sh` to send “Ctrl+L” inside Xvfb.  

If you later connect a physical monitor and want Sitrad to appear on `:0` instead of headless, modify `setup_sitrad.sh` to export `DISPLAY=:0` and remove any Xvfb references.

---

## Internal Workings

### `main.py`

- Loads `.env` variables.  
- Instantiates `SitradDataFetcher`.  
- Instantiates `ThingsBoardClient`.  
- Launches `SendToLauncher`.

### `SitradDataFetcher`

- `fetch_rows()`: Opens SQLite in WAL mode, selects all rows from `tc900log`.  
- `build_payload(row)`: Validates timestamp, constructs payload with fields: `Temp1`, `Temp2`, `defr`, `fans`, `refr`, `dig1`, `dig2`.  
- Includes `"rowid"`, `"ts"`, and a `"values"` dictionary.  
- `fetch_and_prepare()`: Returns a list of payload dicts.

### `ThingsBoardClient`

- Builds the HTTP endpoint URL.  
- `post_json_with_retry()`: Posts JSON with retry/backoff.  
- `send_resilient(batch)`: Sends a batch of payloads reliably.

### `SendToLauncher`

- `start()`:  
  - Calls `_fetch_payloads()` → list of payload dicts.  
  - Calls `_send_in_chunks(payloads)` to split and send in mini‐lots.  
- `_fetch_payloads()`: Returns `[{"rowid":…, "ts":…, "values":{…}}, …]`.  
- `_send_in_chunks(payloads)`:  
  - Splits payloads into chunks of `MAX_MSGS_PER_SEC`.  
  - Calls `_send_fine_grained_batch(chunk)` for each chunk.  
  - Calls `_enforce_rate_limit(window_start)` to ensure ≤ N messages/sec.  
- `_send_fine_grained_batch(batch)`:  
  - Sends each payload individually (`send_resilient([payload])`).  
  - Collects rowids of successful sends into a list.  
  - Calls `delete_rows(db_path, rowids_to_delete)` once per batch.  
- `_enforce_rate_limit(window_start)`: Sleeps the remaining time so that each chunk spans at least 1 second.

---

## Headless Sitrad Utilities

### `setup_sitrad.sh`

- Detects the FTDI adapter and maps it to COM1 in Wine’s `dosdevices`.  
- Blocks COM2–COM20 by creating dummy directories.  
- Adds `alias sitrad4.13='wine "<...>/SitradLocal.exe"'` to `~/.bashrc`.  
- Exports `DISPLAY=:1` (pointing to Xvfb).  
- Starts Wine with Sitrad in the background.  
- Loops until `xdotool search` finds the “Sitrad Local” window in Xvfb.  
- Sleeps 30 seconds for UI initialization.  
- Calls `send_ctrl_l_to_sitrad.sh` to send “Ctrl+L” inside Xvfb.

### `send_ctrl_l_to_sitrad.sh`

- Verifies that `DISPLAY` is set and looks like X11.  
- Uses `xdotool search --name "Sitrad Local"` to find the Wine window (in Xvfb).  
- Sends `Ctrl+L` directly into that window via `xdotool key --window <WID> ctrl+l`.  
- Exits with an error if the window cannot be found or controlled.

---

## Utils

- `utils/log_cleaner.py`  
  - Deletes `.log` files older than `PURGE_LOG_DAYS`.  
- `utils/db_cleaner.py`  
  - Deletes sent rows from the SQLite `tc900log` table in one transaction.

---

## FAQ

**Q: How do I verify that rows were removed?**

```bash
sqlite3 ~/.wine/drive_c/ProgramData/Full\ Gauge/Sitrad/data.db "SELECT COUNT(*) FROM tc900log;"
```

**Q: How do I check if the script is running?**

```bash
systemctl --user list-timers
```

**Q: How do I view the send logs?**

```bash
journalctl --user -u send_to_tb.service -n 50
journalctl --user -u sitrad.service -f
```

**Q: Where should I run `chmod +x`?**

```bash
chmod +x send_to_tb/main.py
chmod +x sitrad/setup_sitrad.sh
chmod +x sitrad/send_ctrl_l_to_sitrad.sh
chmod +x setup_bash/setup_services.sh
chmod +x setup_bash/kill_services.sh
```

**Q: How can I test without actually sending data?**

Temporarily set:

```ini
MAX_MSGS_PER_SEC=0
```

Or comment out `send_resilient(...)` calls in the code.

**Q: How is `~` in `DB_PATH` handled?**

It’s expanded automatically via `os.path.expanduser()`.

**Q: Should I commit `venv/` to version control?**

No—add it to your `.gitignore`.

---

## Extension Possibilities

- Add a new `DataFetcher` (e.g., MySQL, API, CSV) by subclassing `DataFetcher`.  
- Add a new `HttpClient` (e.g., Kafka, another IoT API) by subclassing `HttpClient`.  
- The core `SendToLauncher` logic remains source/destination agnostic.

---

With this updated README, you can:
- Initialize a Python virtual environment.  
- Install dependencies (including `xvfb` and `xdotool` for headless Sitrad).  
- Make scripts executable.  
- Run `send_to_tb` manually or via systemd timer.  
- Run Sitrad PRO under Wine in a headless X server (Xvfb), with automatic “Ctrl+L” after UI load.  
- Monitor emissions to ThingsBoard.  
- Adjust file paths and DISPLAY settings as needed for your environment.